{#
/**
 * @file
 * Theme override for the "L'actualité en vidéos" view with YouTube embeds.
 */
#}

<h3 class="mb-4">L'actualité en vidéos</h3>

{% if rows is not empty %}

  {# --------------------------------------------------------
     MACRO: Extract YouTube Video ID from any embed or URL
     -------------------------------------------------------- #}
  {% macro youtube_id(html) %}
{%- if html matches '/v=([A-Za-z0-9_-]+)/' -%}
{{ html|split('v=')[1]|split('&')[0]|split('"')[0]|trim }}
{%- elseif html matches '/youtu\\.be\\/([A-Za-z0-9_-]+)/' -%}
{{ html|split('youtu.be/')[1]|split('?')[0]|split('"')[0]|trim }}
{%- elseif html matches '/embed\\/([A-Za-z0-9_-]+)/' -%}
{{ html|split('embed/')[1]|split('?')[0]|split('"')[0]|trim }}
{%- else -%}
{%- endif -%}
  {% endmacro %}

  {% import _self as utils %}

  {% set total = view.result|length %}
  {% set max_items = 3 %}
  {% set items = total < max_items ? total : max_items %}

  <div class="row">
    {% for i in 0..(items - 1) %}
      {% set html = view.style_plugin.getField(i, 'field_video_link')|striptags|trim %}
      {% set youtube = utils.youtube_id(html)|trim %}

      <div class="col-lg-4 mb-4">
        <div class="ratio ratio-16x9 mb-3">
          <iframe
            src="https://www.youtube.com/embed/{{ youtube }}"
            title="{{ view.style_plugin.getField(i, 'title') }}"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen>
          </iframe>
        </div>
        <h5 class="mb-2">{{ view.style_plugin.getField(i, 'title') }}</h5>
        <p class="text-muted">{{ view.style_plugin.getField(i, 'field_video_desc') }}</p>
      </div>
    {% endfor %}
  </div>

{% else %}
  {{ empty }}
{% endif %}